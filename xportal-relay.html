<!doctype html>
<html lang="en">
<meta charset="utf-8">
<title>Open xPortal</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;line-height:1.5}
  .card{max-width:720px;margin:auto;padding:16px;border:1px solid #e5e7eb;border-radius:14px}
  code{background:#f3f4f6;padding:2px 6px;border-radius:6px}
  a.button{display:inline-block;padding:10px 14px;border-radius:10px;border:1px solid #e5e7eb;text-decoration:none;margin-right:8px}
</style>
<div class="card">
  <h1>Verify with xPortal</h1>
  <p>1. Apasă pe <b>Open in xPortal</b> pentru a semna mesajul.<br>
     2. După semnare vei fi redirecționat înapoi pe pagina noastră.</p>
  <div style="margin:12px 0">
    <a id="dl" class="button" href="#">Open in xPortal (deeplink)</a>
    <a id="intent" class="button" href="#">Android intent fallback</a>
    <a id="site" class="button" href="#">Continue on Website</a>
  </div>
  <p>Signing message: <code id="nonce">…</code></p>
</div>
<script>
  function qp(name){ return new URL(location.href).searchParams.get(name) || ""; }
  function appendParam(url, key, val){
    try{
      const u = new URL(url);
      u.searchParams.set(key, val);
      return u.toString();
    }catch{
      const j = url.includes("?") ? "&" : "?";
      return url + j + encodeURIComponent(key) + "=" + encodeURIComponent(val);
    }
  }

  const message  = qp("message");
  const callback = qp("callback") || "https://axel4ro.github.io/TheCursedLand/index.html";

  // ✅ propagăm nonce-ul înapoi în site
  const callbackWithMsg = appendParam(callback, "message", message);

  // build targets
  const params = new URLSearchParams({
    message,
    callbackUrl: callbackWithMsg   // <— IMPORTANT
  });

  const deeplink = "xportal://wallet/sign-message?" + params.toString();
  const intent   = "intent://wallet/sign-message?" + params.toString()
                 + "#Intent;scheme=xportal;package=com.elrond.maiar.wallet;end";

  // wire links
  document.getElementById("nonce").textContent = message;
  document.getElementById("dl").href = deeplink;
  document.getElementById("intent").href = intent;
  document.getElementById("openSite").href = callbackWithMsg; // <— și site-ul primește ?message=...
</script>
</html>

