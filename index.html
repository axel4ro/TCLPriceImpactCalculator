<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TCL Price Impact Calculator</title>
  <style>
    :root {
      --bg-light: #f8f9fa;
      --bg-dark: #1a1a1a;
      --text-light: #212529;
      --text-dark: #f1f1f1;
      --card-light: #ffffff;
      --card-dark: #2b2b2b;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 20px auto;
      padding: 0 20px;
      max-width: 900px;
      line-height: 1.6;
      background-color: var(--bg-light);
      color: var(--text-light);
      transition: all 0.3s ease;
    }

    [data-theme="dark"] {
      background-color: var(--bg-dark);
      color: var(--text-dark);
    }

    h2 {
      color: #0d6efd;
      margin-bottom: 8px;
    }

    .section {
      margin-bottom: 24px;
    }

    input[type="text"] {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      margin-top: 4px;
      background-color: var(--card-light);
      border: 1px solid #ccc;
      border-radius: 8px;
      color: inherit;
    }

    [data-theme="dark"] input[type="text"] {
      background-color: var(--card-dark);
      border: 1px solid #444;
      color: #fff;
    }

    button {
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
    }

    #themeToggle {
      float: right;
      font-size: 14px;
      background-color: #444;
      color: white;
      margin-top: -30px;
      margin-bottom: 20px;
    }

    .row-group {
      display: flex;
      gap: 16px;
    }

    .row-group > div {
      flex: 1;
    }

    .result {
      margin-top: 20px;
      background: var(--card-light);
      border-left: 6px solid #28a745;
      padding: 16px;
      white-space: pre-wrap;
      font-size: 15px;
      border-radius: 8px;
    }

    [data-theme="dark"] .result {
      background: var(--card-dark);
    }

    /* ‚úÖ RESPONSIVE */
    @media (max-width: 768px) {
      body {
        margin: 20px 12px;
      }

      .row-group {
        flex-direction: column;
      }

      h2 {
        font-size: 20px;
      }

      input[type="text"],
      button {
        font-size: 15px;
      }

      #themeToggle {
        float: none;
        display: block;
        margin: 10px 0 20px auto;
      }
    }
  </style>
</head>
<body>
  <h2>üìä TCL Price Impact Calculator</h2>
  <button id="themeToggle" onclick="toggleTheme()">üåô Toggle Theme</button>

  <div class="section">
    <strong>üîπ Initial Pool (Listing)</strong><br />
    TCL: <span>4,000,000</span> | USDC ($): <span>25,000</span> | Initial Price: <strong>0.006 $</strong>
  </div>

  <div class="section">
    <strong>üî∏ Current Pool</strong><br />
    <span style="font-size: 13px; color: #0d6efd;">üîµ Data is fetched live from the MultiversX Blockchain (DexScreener)</span>
    <br /><br />
    <div class="row-group">
      <div>
        <label>TCL in pool</label>
        <input type="text" id="curTCL" readonly />
      </div>
      <div>
        <label>USDC ($) in pool</label>
        <input type="text" id="curUSDC" readonly />
      </div>
      <div>
        <label>Current Price (USDC/TCL)</label>
        <input type="text" id="curPrice" readonly />
      </div>
    </div>
  </div>

  <div class="section">
    <strong>üí∞ Simulate Transaction</strong><br />
    <div class="row-group">
      <div style="flex: 2;">
        <label id="inputLabel">Enter amount in <b>USDC ($)</b> to buy TCL:</label>
        <input type="text" id="amount" placeholder="ex: 100" onblur="formatInputField(this)" />
      </div>
      <div style="flex: 1; display: flex; align-items: flex-end;">
        <button onclick="switchMode()" id="switchBtn">üîÅ Switch to: Sell TCL</button>
      </div>
    </div>
  </div>

  <button style="background-color: #28a745;" onclick="calculate()">Calculate Impact</button>
  <div class="result" id="resultBox"></div>

  <script>
    let mode = 'buy';
    const DEX_API_URL = "https://api.dexscreener.io/latest/dex/pairs/multiversx/erd1qqqqqqqqqqqqqpgq6quepqlx66rmwst8uxl6p28jhcrnva982jpszqhxff";

    function formatNumber(n) {
      return Number(n).toLocaleString("en-US", { maximumFractionDigits: 2 });
    }

    function formatInputField(input) {
      let value = input.value.replace(/,/g, '');
      if (!isNaN(value) && value !== '') {
        input.value = formatNumber(value);
      }
    }

    function parseNumber(value) {
      return parseFloat(value.replace(/,/g, '')) || 0;
    }

    function switchMode() {
      const inputLabel = document.getElementById("inputLabel");
      const switchBtn = document.getElementById("switchBtn");
      const input = document.getElementById("amount");
      mode = (mode === 'buy') ? 'sell' : 'buy';

      inputLabel.innerHTML = mode === 'buy'
        ? 'Enter amount in <b>USDC ($)</b> to buy TCL:'
        : 'Enter amount in <b>TCL</b> to sell for USDC ($):';

      switchBtn.innerHTML = mode === 'buy'
        ? 'üîÅ Switch to: Sell TCL'
        : 'üîÅ Switch to: Buy TCL';

      input.value = '';
      document.getElementById("resultBox").innerHTML = '';
    }

    function toggleTheme() {
      const currentTheme = document.body.getAttribute('data-theme') || 'light';
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.body.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      document.getElementById('themeToggle').innerText = newTheme === 'dark'
        ? 'üåû Toggle Theme'
        : 'üåô Toggle Theme';
    }

    function calculate() {
      const tcl = parseNumber(document.getElementById("curTCL").value);
      const usdc = parseNumber(document.getElementById("curUSDC").value);
      const curPrice = parseNumber(document.getElementById("curPrice").value);
      const value = parseNumber(document.getElementById("amount").value);
      const resultBox = document.getElementById("resultBox");

      resultBox.innerHTML = "";
      const feePct = 0.01;
      const valueAfterFee = value * (1 - feePct);

      if (mode === 'buy' && value > 0) {
        const newUSDC = usdc + valueAfterFee;
        const newTCL = (tcl * usdc) / newUSDC;
        const boughtTCL = tcl - newTCL;
        const avgPrice = value / boughtTCL;
        const newPrice = newUSDC / newTCL;
        const priceImpact = ((avgPrice - curPrice) / curPrice) * 100;
        const pctChange = ((newPrice - curPrice) / curPrice) * 100;

        resultBox.innerHTML =
          `‚úÖ Buy TCL with ${formatNumber(value)} USDC ($)\n` +
          `Estimated TCL received: ${formatNumber(boughtTCL)}\n` +
          `Average paid price: ${avgPrice.toFixed(6)} USDC ($)/TCL\n` +
          `üí• Price Impact: ${priceImpact.toFixed(2)}%\n` +
          `üîº Estimated Increase: ${pctChange.toFixed(2)}%\n\n` +
          `üí≤ Estimated final price: ${newPrice.toFixed(6)} USDC ($)\n` +
          `üîÑ Estimated Pool After Transaction:\n` +
          `‚Ä¢ TCL in Pool: ${formatNumber(newTCL)}\n` +
          `‚Ä¢ USDC in Pool: ${formatNumber(newUSDC)}`;
      } else if (mode === 'sell' && value > 0) {
        const newTCL = tcl + valueAfterFee;
        const newUSDC = (usdc * tcl) / newTCL;
        const receivedUSDC = usdc - newUSDC;
        const avgPrice = receivedUSDC / value;
        const newPrice = newUSDC / newTCL;
        const priceImpact = ((curPrice - avgPrice) / curPrice) * 100;
        const pctChange = ((newPrice - curPrice) / curPrice) * 100;

        resultBox.innerHTML =
          `‚úÖ Sell ${formatNumber(value)} TCL\n` +
          `Estimated USDC ($) received: ${formatNumber(receivedUSDC)}\n` +
          `Average received price: ${avgPrice.toFixed(6)} USDC ($)/TCL\n` +
          `üí• Price Impact: ${priceImpact.toFixed(2)}%\n` +
          `üîª Estimated Decrease: ${pctChange.toFixed(2)}%\n\n` +
          `üí≤ Estimated TCL final price: ${newPrice.toFixed(6)} USDC ($)\n` +
          `üîÑ Estimated Pool After Transaction:\n` +
          `‚Ä¢ TCL in Pool: ${formatNumber(newTCL)}\n` +
          `‚Ä¢ USDC in Pool: ${formatNumber(newUSDC)}`;
      } else {
        resultBox.innerHTML = "‚ö†Ô∏è Please enter a valid amount.";
      }
    }

    async function fetchPoolData() {
      try {
        const res = await fetch(DEX_API_URL);
        const data = await res.json();
        const pool = data.pair;
        document.getElementById("curTCL").value = formatNumber(pool.liquidity.base);
        document.getElementById("curUSDC").value = formatNumber(pool.liquidity.quote);
        document.getElementById("curPrice").value = parseFloat(pool.priceUsd).toFixed(6);
      } catch (err) {
        console.error("‚ùå Failed to fetch pool data:", err);
      }
    }

    window.onload = () => {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.body.setAttribute('data-theme', savedTheme);
      document.getElementById('themeToggle').innerText = savedTheme === 'dark'
        ? 'üåû Toggle Theme'
        : 'üåô Toggle Theme';
      fetchPoolData();
    };
  </script>
</body>
</html>

