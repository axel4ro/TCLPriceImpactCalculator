<!doctype html>
<html lang="ro">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TCL dApp · Conectare xPortal (WalletConnect v2)</title>
<style>
  :root{--bdr:#e5e7eb;--muted:#6b7280;--txt:#111827;--bg:#fff;--mono:#f3f4f6;--brand:#10b981}
  *{box-sizing:border-box}body{margin:24px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--txt);background:var(--bg)}
  .wrap{max-width:880px;margin:auto}
  .card{border:1px solid var(--bdr);border-radius:16px;padding:18px;margin:14px 0}
  h1{margin:0 0 12px;font-size:28px}
  h2{margin:0 0 8px}
  .muted{color:var(--muted);font-size:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--bdr);background:#fff;cursor:pointer}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;background:var(--mono);padding:6px 8px;border-radius:10px;word-break:break-all}
  .grid{display:grid;grid-template-columns:160px 1fr;gap:8px 12px;align-items:start}
  #qr{width:320px;max-width:100%;background:#fff;border-radius:12px;padding:12px;border:1px dashed var(--bdr)}
  .center{display:grid;place-items:center}
  .hidden{display:none !important}
</style>

<div class="wrap">
  <div class="card center">
    <div>
      <h1>Conectează-te cu xPortal</h1>
      <p class="muted">WalletConnect v2 – funcționează pe desktop (QR) și mobil (deeplink). Găzduire statică – perfect pentru GitHub Pages.</p>
    </div>
  </div>

  <div id="connectCard" class="card">
    <h2>1) Scanează sau deschide xPortal</h2>
    <div class="row" style="margin-bottom:10px">
      <button id="btnConnect" class="btn primary">Connect xPortal</button>
      <span class="muted">sau scanează QR-ul de mai jos ⤵</span>
    </div>
    <div id="qr" class="center">
      <div class="muted">QR va apărea aici după ce apeși <b>Connect xPortal</b>.</div>
    </div>
    <p class="muted" style="margin-top:10px">Mobil: apasă „Connect xPortal” pentru a deschide aplicația. Desktop: scanează QR cu xPortal.</p>
  </div>

  <div id="statusCard" class="card hidden">
    <h2>Stare conexiune</h2>
    <div class="grid">
      <div class="muted">Status</div><div id="status" class="mono">disconnected</div>
      <div class="muted">Wallet</div><div id="address" class="mono">—</div>
      <div class="muted">Rețea</div><div id="network" class="mono">mvx:1 (mainnet)</div>
    </div>
    <div class="row" style="margin-top:12px">
      <button id="btnDisconnect" class="btn">Disconnect</button>
      <button id="btnCopyAddr" class="btn">Copy address</button>
    </div>
  </div>

  <div id="signCard" class="card hidden">
    <h2>Sign Message</h2>
    <p class="muted">Mesajul de semnat (nonce) poate veni din URL (?message=...) sau îl poți edita mai jos.</p>
    <div class="row" style="margin-bottom:10px">
      <input id="msg" class="mono" style="flex:1" value="TCL-VERIFY" />
      <button id="btnSign" class="btn">Sign in xPortal</button>
      <button id="btnCopySig" class="btn">Copy signature (Base64)</button>
    </div>
    <div class="grid">
      <div class="muted">Signature (hex)</div><div id="sigHex" class="mono">—</div>
      <div class="muted">Signature (Base64)</div><div id="sigB64" class="mono">—</div>
    </div>
  </div>
</div>

<script type="module">
import { WalletConnectV2Provider as WalletConnectProvider } from "https://esm.sh/@multiversx/sdk-wallet-connect-provider@6.1.2";
import QRCode from "https://esm.sh/qrcode@1.5.3";
import { Buffer } from "https://esm.sh/buffer@6.0.3";
if (!globalThis.Buffer) globalThis.Buffer = Buffer;

const WC_PROJECT_ID = "3b2862ec02219f2359a7d54b5f0f46ff";
const RELAY_URL = "wss://relay.walletconnect.com";
const CHAIN_ID = "1";
const MVX_CHAIN = `mvx:${CHAIN_ID}`;

const $ = (id) => document.getElementById(id);
const qrDiv = $("qr");
const btnConnect = $("btnConnect");
const btnDisconnect = $("btnDisconnect");
const btnCopyAddr = $("btnCopyAddr"); // ← asigură-te că butonul are acest id
const statusEl = $("status");
const addrEl = $("address");
const netEl = $("network");
const connectCard = $("connectCard");
const statusCard = $("statusCard");
const signCard = $("signCard");
const btnSign = $("btnSign");
const btnCopySig = $("btnCopySig");
const msgEl = $("msg");
const sigHexEl = $("sigHex");
const sigB64El = $("sigB64");

let provider = null;
let pendingApproval = null;
let lastUri = null;
let queryMsg = null;

const isMobile = () => /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
const qp = (k) => new URL(location.href).searchParams.get(k) || "";
function qph(k){ const h = new URL(location.href).hash.replace(/^#/, ""); if (!h) return ""; const sp = new URLSearchParams(h); return sp.get(k) || ""; }

function show(el){ el.classList.remove("hidden"); }
function hide(el){ el.classList.add("hidden"); }

function setDisconnected(){
  statusEl.textContent = "disconnected";
  addrEl.textContent = "—";
  sigHexEl.textContent = "—";
  sigB64El.textContent = "—";
  show(connectCard);
  hide(statusCard); hide(signCard);
}

function setConnected(address){
  statusEl.textContent = "connected";
  addrEl.textContent = address || "—";
  hide(connectCard);
  show(statusCard); show(signCard);
}

async function initProvider(){
  if (provider) return provider;
  const callbacks = {
    onClientLogin: async () => {
      const address = await provider.getAddress();
      setConnected(address);
      if (queryMsg) { try { await signCurrentMessage(); } catch(e){ console.error(e); } }
    },
    onClientLogout: async () => { setDisconnected(); }
  };
  provider = new WalletConnectProvider(callbacks, CHAIN_ID, RELAY_URL, WC_PROJECT_ID, { logger: "error" });
  await provider.init();
  netEl.textContent = `${MVX_CHAIN} (mainnet)`;
  return provider;
}

function buildDeeplink(uri){
  const u = encodeURIComponent(uri);
  return [`xportal://walletconnect?uri=${u}`, `xportal://wc?uri=${u}`];
}

async function renderQR(uri){
  const svg = await QRCode.toString(uri, { type: "svg", margin: 1 });
  qrDiv.innerHTML = svg;
}

async function startConnect(){
  await initProvider();
  const { uri, approval } = await provider.connect({ methods: ["mvx_signMessage"] });
  lastUri = uri; pendingApproval = approval;
  await renderQR(uri);
  if (isMobile()) {
    const links = buildDeeplink(uri);
    let i = 0; const tryOpen = () => {
      if (i >= links.length) return;
      window.location.href = links[i++];
      setTimeout(tryOpen, 500);
    };
    tryOpen();
  }
  await provider.login({ approval });
}

async function signCurrentMessage(){
  if (!provider) { alert("Nu ești conectat."); return; }
  const text = String(msgEl?.value ?? "");
  if (!text.length) { alert("Mesaj gol"); return; }

  // transformăm mesajul într-un array de octeți (number[])
  const bytesArray = Array.from(Buffer.from(text, "utf8")); // ex: [84,67,76,45,65,66...]

  // CORECTARE: Trimitem direct array-ul de bytes, nu un obiect
  const res = await provider.signMessage(bytesArray); // { signature: hex, address }

  const hex = res?.signature || "";
  if (!hex) { alert("Nu am primit semnătura din xPortal."); return; }

  // afișează HEX
  sigHexEl.textContent = hex;

  // HEX -> Base64 (pentru /verify_sign)
  const b = Uint8Array.from(hex.match(/.{1,2}/g).map(h => parseInt(h, 16)));
  const b64 = btoa(String.fromCharCode(...b));
  sigB64El.textContent = b64 || "—";
}

// ── Listeners
btnConnect.addEventListener('click', async () => {
  try { await startConnect(); }
  catch (e) { console.error(e); alert("Connect error: " + (e?.message || e)); setDisconnected(); }
});

btnDisconnect.addEventListener('click', async () => {
  try { if (provider) await provider.logout(); } catch {}
  setDisconnected();
});

btnCopyAddr.addEventListener('click', async () => {
  const txt = addrEl.textContent || "";
  try { await navigator.clipboard.writeText(txt); alert('Copied!'); }
  catch { alert('Copy failed'); }
});

btnSign.addEventListener('click', async () => {
  try { await signCurrentMessage(); }
  catch(e){ alert("Sign error: " + (e?.message || e)); }
});

btnCopySig.addEventListener('click', async () => {
  const txt = sigB64El.textContent || "";
  try { await navigator.clipboard.writeText(txt); alert('Signature (Base64) copied!'); }
  catch { alert('Copy failed'); }
});

// ── Init: preia message/nonce din URL sau hash
queryMsg =
  qp("message") || qp("nonce") || qp("msg") || qp("m") ||
  qph("message") || qph("nonce") || "";

if (queryMsg) { try { msgEl.value = queryMsg; } catch{} }
setDisconnected();
</script>






