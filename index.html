<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- 🔥 Ajustat pentru mobile să facă zoom-out -->
  <meta name="viewport" content="width=device-width, initial-scale=0.85, minimum-scale=0.5, maximum-scale=1.0, user-scalable=yes" />
  <title>The Cursed Land</title>
  <style>
:root {
  --bg-dark: #161a24;
  --text-dark: #f1f1f1;
  --card-dark: #161a24;
}

/* BODY */
body {
  font-family: Arial, sans-serif;
  margin: 20px auto;
  padding: 0 20px;
  max-width: 1000px;
  line-height: 1.6;
  background-color: var(--bg-dark);
  color: var(--text-dark);
  overflow-x: auto;
  -webkit-text-size-adjust: none;
}

/* Navigația fixă sus */
.nav-buttons {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  z-index: 1000;
  background: var(--bg-dark);
  padding: 10px;
  display: flex;
  gap: 10px;
  margin-bottom: 20px;

  /* 🔥 Scroll orizontal când nu încap butoanele */
  overflow-x: auto;
  -webkit-overflow-scrolling: touch; /* smooth pe iOS */
}
.nav-buttons::-webkit-scrollbar {
  display: none; /* ascunde scrollbar-ul */
}
.nav-buttons button {
  flex: 1 0 auto; /* păstrează lățimea butoanelor, nu le micșorează forțat */
  padding: 10px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  background: #007bff;
  color: #fff;
  font-size: 16px;
  font-weight: 600;
  transition: background 0.2s;
  white-space: nowrap; /* 🔥 previne să intre pe 2 rânduri */
}
.nav-buttons button.active {
  background: #28a745;
}

/* Indicator swipe pentru nav */
.nav-swipe-hint {
  text-align: center;
  font-size: 13px;
  color: #0d6efd;
  margin: 6px 0 10px 0; /* spațiu sus și jos */
  display: none;
}

@media (max-width: 1024px) {
  .nav-swipe-hint {
    display: block;
  }
}


#token.fullpage {
  position: fixed;
  top: 60px; /* cât are nav-ul */
  left: 0;
  width: 100%;
  height: calc(100% - 60px);
  margin: 0;
  padding: 0;
  z-index: 500;
  background: var(--bg-dark);
}
#token.fullpage iframe {
  width: 100%;
  height: 100%;
  border: none;
}

#xexchangeIframe.fullpage {
  position: fixed;
  top: 60px;
  left: 0;
  width: 100%;
  height: calc(100% - 60px);
  margin: 0;
  padding: 0;
  z-index: 500;
  background: var(--bg-dark);
}
#xexchangeIframe.fullpage iframe {
  width: 100%;
  height: 100%;
  border: none;
}


/* Carduri evenimente */
.event-card {
  border-radius: 12px;
  padding: 14px 16px;
  margin-bottom: 14px;
  background: var(--card-dark);
  color: var(--text-dark);
  border: 1px solid #333;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  transition: all 0.2s ease;
}
.event-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.event-title {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 4px;
}
.event-desc {
  font-size: 14px;
  margin-bottom: 6px;
  color: #a1a1aa;
}
.event-status {
  font-size: 13px;
  font-weight: 600;
}

/* Status colors */
.event-status.active { border-left: 6px solid #10b981; }
.event-status.upcoming { border-left: 6px solid #facc15; }
.event-expired { border-left: 6px solid #ef4444 !important; }

/* Tabele */
#stakingTable {
  width: 100%;
  border-collapse: collapse;
  table-layout: auto;
}
#stakingTable th, #stakingTable td {
  padding: 6px;
  text-align: center;
  white-space: nowrap;
}

/* Titluri și secțiuni */
h2 {
  color: #0d6efd;
  margin-bottom: 8px;
}
.section {
  margin-bottom: 24px;
}

/* Inputuri */
input[type="text"] {
  width: 100%;
  padding: 10px;
  font-size: 16px;
  margin-top: 4px;
  background-color: var(--card-dark);
  border: 1px solid #444;
  border-radius: 8px;
  color: #fff;
}

/* HIDE/SHOW SECTIONS */
.section-page {
  display: none;
  padding-top: 40px; /* 🔥 ajustat să lase doar cât trebuie sub navigație */
}
.section-page.active {
  display: block;
}

/* Token special: full screen fără padding */
#token.fullpage {
  position: fixed;
  top: 60px; /* cât are nav-ul */
  left: 0;
  width: 100%;
  height: calc(100% - 60px);
  margin: 0;
  padding: 0;  /* eliminăm paddingul */
  z-index: 500;
  background: var(--bg-dark);
}

#explorerIframe.fullpage {
  position: fixed;
  top: 60px;
  left: 0;
  width: 100%;
  height: calc(100% - 60px);
  margin: 0;
  padding: 0;
  z-index: 500;
  background: var(--bg-dark);
}
#explorerIframe.fullpage iframe {
  width: 100%;
  height: 100%;
  border: none;
}



/* Butoane */
button {
  padding: 10px 20px;
  background-color: #007bff;
  color: white;
  border: none;
  font-size: 16px;
  border-radius: 8px;
  cursor: pointer;
}
button:hover { opacity: 0.9; }

/* Rezultate */
.result {
  margin-top: 20px;
  background: var(--card-dark);
  border-left: 6px solid #28a745;
  padding: 16px;
  white-space: pre-wrap;
  font-size: 15px;
  border-radius: 8px;
}

/* Alte layouturi */
.row-group { display: flex; gap: 16px; }
.row-group > div { flex: 1; }

.action-row {
  display:flex;
  gap:12px;
  align-items:center;
  margin-top:12px;
}
.btn-trade {
  display:inline-block;
  padding:10px 20px;
  border-radius:8px;
  text-decoration:none;
  background:#2ff6de;
  color:#090909;
  font-size:16px;
  font-weight:600;
}
.btn-trade:hover { opacity:.9; }

.stats-row { display:flex; gap:16px; flex-wrap:wrap; }
.stat {
  flex:1;
  padding:10px 12px;
  border:1px solid #444;
  border-radius:10px;
  background: var(--card-dark);
  min-width:160px;
}
.stat-top {
  display:flex;
  align-items:center;
  justify-content:space-between;
  font-size:13px;
  color:#6b7280;
}
.stat-value {
  font-size:18px;
  font-weight:700;
  margin-top:6px;
}
.chip-live {
  font-size:11px;
  padding:2px 8px;
  border-radius:999px;
  background:#10b9811a;
  color:#10b981;
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.chip-live::before { content:"🔒"; }

/* Responsive */
@media (max-width: 768px) {
  body { margin: 20px 12px; }
  .row-group { flex-direction: column; }
  h2 { font-size: 20px; }
  input[type="text"], button { font-size: 15px; }
  .stats-row{ flex-direction:column; }
}

/* Dexscreener aspect ratio */
#dexscreener-embed { position:relative; width:100%; padding-bottom:125%; }
@media(min-width:1400px){ #dexscreener-embed{padding-bottom:65%;} }
#dexscreener-embed iframe { position:absolute; width:100%; height:100%; top:0; left:0; border:0; }


  </style>
</head>
<body>
<!-- NAVIGATION -->
<div class="nav-buttons">
  <button onclick="showPage('explorer')" id="btn-explorer" class="active">🪙 Token</button>
  <button onclick="showPage('token')" id="btn-token">📊 Chart</button>
  <button onclick="showPage('calculator')" id="btn-calculator">🧮 Calculator</button>
  <button onclick="showPage('xexchangeIframe')" id="btn-xexchangeIframe">💱 xExchange</button>
  <button onclick="showPage('explorerIframe')" id="btn-explorerIframe">🌐 Explorer</button>
  <button onclick="showPage('staking')" id="btn-staking">🏆 Top Staking</button>
  <button onclick="showPage('events')" id="btn-events">📅 Events</button>
</div>

<!-- 🔥 Hint-ul de swipe îl punem sub navigație -->
<div class="nav-swipe-hint">◀️ Swipe ▶️</div>


  <!-- Explorer -->
  <div id="explorer" class="section-page active">
    <h2>🪙 Token</h2>

    <div class="section">
      <strong><span class="chip-live">LIVE DATA</span></strong>
      <div class="stats-row">
        <div class="stat"><div class="stat-top"><span>Current Price</span><span class="chip-live">Live</span></div><div id="curPrice" class="stat-value">—</div></div>
        <div class="stat"><div class="stat-top"><span>ATH</span><span class="chip-live">Live</span></div><div id="ath" class="stat-value">—</div></div>
        <div class="stat"><div class="stat-top"><span>ATL</span><span class="chip-live">Live</span></div><div id="atl" class="stat-value">—</div></div>
        <div class="stat"><div class="stat-top"><span>TCL Supply</span><span class="chip-live">Live</span></div><div id="curTCL" class="stat-value">—</div></div>
        <div class="stat"><div class="stat-top"><span>USDC Supply</span><span class="chip-live">Live</span></div><div id="curUSDC" class="stat-value">—</div></div>
      </div>
      <span style="font-size: 13px; color: #0d6efd; display:block; margin-top:10px;">
        🔵 Data is fetched live from the MultiversX Blockchain (DexScreener & CoinGecko)
      </span>
    </div>

    <div class="section">
      <strong><span class="chip-live">Initial Liquidity (Listing)</span></strong>
      <div class="stats-row">
        <div class="stat"><div class="stat-top"><span>TCL Supply</span></div><div class="stat-value">4,000,000</div></div>
        <div class="stat"><div class="stat-top"><span>USDC Supply</span></div><div class="stat-value">25,000 $</div></div>
        <div class="stat"><div class="stat-top"><span>Initial Price</span></div><div class="stat-value">0.006 $</div></div>
      </div>
    </div>
	

  </div>

<!-- xExchange Trade -->
<div id="xexchangeIframe" class="section-page">
  <iframe 
    src="https://xexchange.com/trade?firstToken=USDC-c76f1f&secondToken=TCL-fe459d"
    style="width:100%;height:100%;border:0;">
  </iframe>
</div>


  <!-- Calculator -->
  <div id="calculator" class="section-page">
    <h2>🧮 Simulate Transaction</h2>
    <div class="row-group">
      <div style="flex: 2;">
        <label id="inputLabel">Enter amount in <b>USDC ($)</b> to buy TCL:</label>
        <input type="text" id="amount" placeholder="ex: 100" onblur="formatInputField(this)" />
      </div>
      <div style="flex: 1; display: flex; align-items: flex-end;">
        <button onclick="switchMode()" id="switchBtn">🔁 Switch to: Sell TCL</button>
      </div>
    </div>
    <div class="action-row">
      <button style="background-color:#28a745;" onclick="calculate()">Calculate Impact</button>
      <a class="btn-trade" href="https://xexchange.com/trade?firstToken=USDC-c76f1f&secondToken=TCL-fe459d" target="_blank" rel="noopener noreferrer">Trade Now ↗</a>
    </div>
    <div class="result" id="resultBox"></div>
  </div>

<!-- Events -->
<div id="events" class="section-page">
  <h2>📅 Weekly Events</h2>
  <small style="color:#6b7280; display:block; margin-bottom:10px; font-size:13px;">
    Data is live – synced with <code>The Cursed Land in-game Weekely Events</code>
  </small>

  <div id="eventContainer">
    ⏳ Loading events...
  </div>

  <div style="margin-top:15px; display:flex; gap:6px; flex-wrap:wrap;" id="eventButtons"></div>
</div>


<!-- TCL Token Chart -->
<div id="token" class="section-page">
  <iframe 
    src="https://dexscreener.com/multiversx/erd1qqqqqqqqqqqqqpgq6quepqlx66rmwst8uxl6p28jhcrnva982jpszqhxff?embed=1&loadChartSettings=0&tabs=0&info=0&chartLeftToolbar=0&chartDefaultOnMobile=1&chartTheme=dark&theme=dark&chartStyle=1&chartType=usd&interval=15">
  </iframe>
</div>

  
  <!-- Explorer MultiversX -->
<div id="explorerIframe" class="section-page">
  <iframe 
    src="https://explorer.multiversx.com/tokens/TCL-fe459d"
    style="width:100%;height:100%;border:0;">
  </iframe>
</div>



<!-- Staking -->
<div id="staking" class="section-page">
  <h2>🏆 TCL Staking Leaderboard</h2>
  <small id="lastUpdated" style="color:#6b7280; display:block; margin-bottom:10px; font-size:13px;">
    ⏳ Loading update time...
  </small>

  <table id="stakingTable" style="width:100%;border-collapse:collapse;margin-top:15px;">
    <thead>
      <tr style="background:#007bff;color:white;">
        <th style="padding:8px; text-align:center;">Rank</th>
        <th style="padding:8px; text-align:center;">Address</th>
        <th style="padding:8px; text-align:center;">Total TCL</th>
        <th style="padding:8px; text-align:center;">NFT</th>
        <th style="padding:8px; text-align:center;">Loan</th>
        <th style="padding:8px; text-align:center;">Infinity</th>
      </tr>
    </thead>
    <tbody id="stakingBody">
      <tr><td colspan="6" style="padding:10px;text-align:center;">⏳ Loading leaderboard...</td></tr>
    </tbody>
  </table>
</div>

<script>

  let mode = 'buy';
  const DEX_API_URL = "https://api.dexscreener.io/latest/dex/pairs/multiversx/erd1qqqqqqqqqqqqqpgq6quepqlx66rmwst8uxl6p28jhcrnva982jpszqhxff";
  const LEADERBOARD_URL = "https://axel4ro.github.io/TCLPriceImpactCalculator/leaderboard.json";
  const MULTIVERSX_API = "https://api.multiversx.com";

  // ===== Utils =====
  function formatNumber(n) {
    return Number(n).toLocaleString("en-US", { maximumFractionDigits: 2 });
  }
  function parseNumber(value) {
    return parseFloat((value || '').toString().replace(/,/g, '')) || 0;
  }
  function formatInputField(input) {
    let value = input.value.replace(/,/g, '');
    if (!isNaN(value) && value !== '') input.value = formatNumber(value);
  }
  function getText(id){ return (document.getElementById(id).textContent || '').trim(); }
  function setText(id, v){ document.getElementById(id).textContent = v; }

  // ===== Calculator =====
  function switchMode() {
    const inputLabel = document.getElementById("inputLabel");
    const switchBtn = document.getElementById("switchBtn");
    const input = document.getElementById("amount");
    mode = (mode === 'buy') ? 'sell' : 'buy';
    inputLabel.innerHTML = mode === 'buy'
      ? 'Enter amount in <b>USDC ($)</b> to buy TCL:'
      : 'Enter amount in <b>TCL</b> to sell for USDC ($):';
    switchBtn.innerHTML = mode === 'buy' ? '🔁 Switch to: Sell TCL' : '🔁 Switch to: Buy TCL';
    input.value = ''; 
    document.getElementById("resultBox").innerHTML = '';
  }


  function calculate() {
    const tcl = parseNumber(getText("curTCL"));
    const usdc = parseNumber(getText("curUSDC"));
    const curPrice = parseNumber(getText("curPrice"));
    const value = parseNumber(document.getElementById("amount").value);
    const resultBox = document.getElementById("resultBox");
    resultBox.innerHTML = "";
    const feePct = 0.01, valueAfterFee = value * (1 - feePct);

    if (mode === 'buy' && value > 0) {
      const newUSDC = usdc + valueAfterFee;
      const newTCL = (tcl * usdc) / newUSDC;
      const boughtTCL = tcl - newTCL;
      const avgPrice = value / boughtTCL;
      const newPrice = newUSDC / newTCL;
      const priceImpact = (avgPrice - curPrice) / avgPrice * 100;
      const pctChange = ((newPrice - curPrice) / curPrice) * 100;
      resultBox.innerHTML =
        "💱 Buy TCL with " + formatNumber(value) + " USDC ($)\n" +
        "💲 Estimated TCL received: " + formatNumber(boughtTCL) + "\n" +
        "⚖️ Average paid price: " + avgPrice.toFixed(6) + " USDC/TCL\n" +
        "💥 Price Impact: " + priceImpact.toFixed(2) + "%\n" +
        "📈 Estimated Increase: + " + pctChange.toFixed(2) + "%\n\n" +
        "📊 Estimated TCL final price: " + newPrice.toFixed(6) + " USDC ($)\n" +
        "🔄 Estimated Supply After Transaction:\n" +
        "• TCL in Pool: " + formatNumber(newTCL) + "\n" +
        "• USDC in Pool: " + formatNumber(newUSDC);
    } else if (mode === 'sell' && value > 0) {
      const newTCL = tcl + valueAfterFee;
      const newUSDC = (usdc * tcl) / newTCL;
      const receivedUSDC = usdc - newUSDC;
      const avgPrice = receivedUSDC / value;
      const newPrice = newUSDC / newTCL;
      const priceImpact = ((curPrice - avgPrice) / curPrice) * 100;
      const pctChange = ((newPrice - curPrice) / curPrice) * 100;
      resultBox.innerHTML =
        "💱 Sell " + formatNumber(value) + " TCL\n" +
        "💲 Estimated USDC ($) received: " + formatNumber(receivedUSDC) + "\n" +
        "⚖️ Average received price: " + avgPrice.toFixed(6) + " USDC/TCL\n" +
        "💥 Price Impact: " + priceImpact.toFixed(2) + "%\n" +
        "📉 Estimated Decrease: " + pctChange.toFixed(2) + "%\n\n" +
        "📊 Estimated TCL final price: " + newPrice.toFixed(6) + " USDC ($)\n" +
        "🔄 Estimated Supply After Transaction:\n" +
        "• TCL in Pool: " + formatNumber(newTCL) + "\n" +
        "• USDC in Pool: " + formatNumber(newUSDC);
    } else {
      resultBox.innerHTML = "⚠️ Please enter a valid amount.";
    }
  }
const EVENTS_URL = "https://axel4ro.github.io/TCLPriceImpactCalculator/weekly_events.json";
let eventsData = {};
let currentDay = null;

// Încarcă events din JSON
async function loadEvents() {
  try {
    const res = await fetch(EVENTS_URL + "?t=" + Date.now());
    eventsData = await res.json();
    const todayIndex = new Date().getUTCDay(); // 0=Sun, 1=Mon
    const weekdays = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    currentDay = weekdays[todayIndex];
    renderDayButtons(currentDay);
    showEventsForDay(currentDay);
  } catch (err) {
    document.getElementById("eventContainer").innerHTML = "❌ Error loading events.";
    console.error("Events load error", err);
  }
}

// Butoane zile
function renderDayButtons(activeDay) {
  const weekdays = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
  let html = "";
  weekdays.forEach(day => {
    const isActive = day === activeDay;
    html += `<button onclick="showEventsForDay('${day}')"
                style="flex:1; padding:6px; border-radius:6px; border:none; cursor:pointer; font-weight:600;
                       background:${isActive ? '#28a745' : '#007bff'}; color:white;">
                ${day}
             </button>`;
  });
  document.getElementById("eventButtons").innerHTML = html;
}

// Afișare evenimente
function showEventsForDay(day) {
  currentDay = day;
  renderDayButtons(day);

  const container = document.getElementById("eventContainer");
  const events = eventsData[day] || [];
  if (events.length === 0) {
    container.innerHTML = "<p>No events scheduled.</p>";
    return;
  }

  const weekdays = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  let now = new Date();
  let html = "";

  events.forEach(ev => {
    let [sh, sm] = ev.start.split(":").map(Number);
    let [eh, em] = ev.end.split(":").map(Number);

    let targetIndex = weekdays.indexOf(day);

    let targetDate = new Date(Date.UTC(
      now.getUTCFullYear(),
      now.getUTCMonth(),
      now.getUTCDate() - now.getUTCDay() + targetIndex,
      sh, sm
    ));

    let start = new Date(targetDate);
    let end = new Date(targetDate);
    end.setUTCHours(eh, em, 0, 0);

    if (end <= start) end.setUTCDate(end.getUTCDate() + 1);
    if (end < now) {
      start.setUTCDate(start.getUTCDate() + 7);
      end.setUTCDate(end.getUTCDate() + 7);
    }

    let statusText = "";
    let borderClass = "";

    if (now >= start && now <= end) {
      // 🔵 Event is ACTIVE
      let diff = Math.floor((end - now) / 60000);
      let h = Math.floor(diff / 60), m = diff % 60;
      statusText = `🔵 Active Now – ends in ${h}h ${m}m`;
      borderClass = "event-active";
    } else {
      let diff = Math.floor((start - now) / 60000);
      let h = Math.floor(diff / 60), m = diff % 60;

      if (diff <= 0) {
        statusText = "🔴 Event Ended";
        borderClass = "event-expired";
      } else if (diff <= 24 * 60) {
        statusText = `🟡 Starts in ${h}h ${m}m`;
        borderClass = "event-soon";
      } else {
        statusText = `🟠 Starts in ${h}h ${m}m`;
      }
    }

    let durMs = end - start;
    let durH = Math.floor(durMs / 3600000);
    let durM = (durMs % 3600000) / 60000;

    html += `
      <div class="event-card ${borderClass}">
        <div class="event-title">${ev.name}</div>
        <div class="event-desc">${ev.description}</div>
        <div class="event-status">
          ${statusText} • ⏱ Duration: ${durH>0 ? durH+'h ' : ''}${durM>0 ? durM+'m' : ''}
        </div>
      </div>`;
  });

  container.innerHTML = html;
}



  // ===== Data Fetch =====
  async function fetchPoolData() {
    try {
      const res = await fetch(DEX_API_URL);
      const data = await res.json();
      const pool = data.pair;
      setText("curTCL", formatNumber(pool.liquidity.base));
      setText("curUSDC", formatNumber(pool.liquidity.quote) + " $");
      setText("curPrice", parseFloat(pool.priceUsd).toFixed(6) + " $");
    } catch (err) { console.error("❌ Failed to fetch pool data:", err); }
  }

  async function fetchGeckoAthAtl(){
    try {
      const resp = await fetch("https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=lander");
      const arr = await resp.json();
      if(arr && arr.length > 0){
        const data = arr[0];
        setText("ath", data.ath.toFixed(6) + " $");
        setText("atl", data.atl.toFixed(6) + " $");
      }
    } catch(e){ console.error("❌ CoinGecko ATH/ATL error", e); }
  }

  // ===== Staking Leaderboard din JSON =====
function formatTcl(val, decimals = 18) {
  if (!val) return "0";

  // transformăm valoarea într-un string "normal" (fără e+xx)
  let strVal = typeof val === "number"
  ? val.toLocaleString("fullwide", { useGrouping: false })
  : val.toString(); // ✅ merge și cu string


  // acum folosim BigInt
  let num = BigInt(strVal);
  let divisor = BigInt(10) ** BigInt(decimals);

  let whole = num / divisor;

  return whole.toLocaleString("en-US");
}


let lastUpdateTime = null;

async function fetchLeaderboard() {
  const body = document.getElementById("stakingBody");
  const statusEl = document.getElementById("lastUpdated");

  if (!body) return;

  body.innerHTML = '<tr><td colspan="6" style="padding:10px;text-align:center;">⏳ Leaderboard is being updated on-chain...</td></tr>';
  statusEl.textContent = "⏳ Fetching latest staking data...";

  try {
    const resp = await fetch(LEADERBOARD_URL + "?t=" + Date.now());
    if (!resp.ok) {
      statusEl.textContent = "❌ Failed to load leaderboard";
      return;
    }

const data = await resp.json();

if (!data || Object.keys(data).length === 0) {
  body.innerHTML = '<tr><td colspan="6" style="padding:10px;text-align:center;">⚠️ No data available (update in progress)</td></tr>';
  statusEl.textContent = "⚠️ Leaderboard update still in progress...";
  return;
}

// ✅ acum lucrăm direct cu data
lastUpdateTime = new Date();

const results = Object.entries(data).map(([addr, v]) => ({
  addr,
  rank: v.rank,
  nft: v.nft,
  loan: v.loan,
  infinity: v.infinity,
  total: v.total
}));

// sortăm după rank
results.sort((a, b) => a.rank - b.rank);

// ✅ filtrăm cei cu 0 peste tot
const filtered = results.filter(r =>
  Number(r.total) > 0 ||
  Number(r.nft) > 0 ||
  Number(r.loan) > 0 ||
  Number(r.infinity) > 0
);

// ✅ păstrăm doar primii 100
const top100 = filtered.slice(0, 100);

let html = "";
top100.forEach(r => {
  let shortAddr = r.addr.slice(0, 6) + ".........." + r.addr.slice(-4);
  html += "<tr>" +
    "<td style='padding:6px;text-align:center;'>" + r.rank + "</td>" +
    "<td style='padding:6px;'>" + shortAddr + "</td>" +
    "<td style='padding:6px;font-weight:bold;'>" + formatTcl(r.total) + "</td>" +
    "<td style='padding:6px;'>" + formatTcl(r.nft) + "</td>" +
    "<td style='padding:6px;'>" + formatTcl(r.loan) + "</td>" +
    "<td style='padding:6px;'>" + formatTcl(r.infinity) + "</td>" +
  "</tr>";
});

body.innerHTML = html;


    updateLastUpdated();
	  
  } catch (err) {
    console.error("Leaderboard error", err);
    statusEl.textContent = "❌ Error loading leaderboard";
    body.innerHTML =
      '<tr><td colspan="6" style="padding:10px;text-align:center;">⚠️ Error loading leaderboard</td></tr>';
  }
}

  function updateStakingLeaderboard() {
    fetchLeaderboard();
  }
	
function updateLastUpdated() {
  if (!lastUpdateTime) return;
  const now = new Date();
  const diffMs = now - lastUpdateTime;
  const diffMins = Math.floor(diffMs / 60000);
  const diffSecs = Math.floor((diffMs % 60000) / 1000);

  let text = "✅ Last update on-chain: " + lastUpdateTime.toLocaleString() + " (";
  if (diffMins > 0) {
    text += diffMins + " minute" + (diffMins > 1 ? "s" : "");
  } else if (diffSecs < 10) {
    text += "just now";
  } else {
    text += diffSecs + " seconds ago";
  }
  text += ")";
  document.getElementById("lastUpdated").textContent = text;
}

// Actualizează automat la fiecare secundă textul
setInterval(updateLastUpdated, 1000);


// ===== Navigation =====
function showPage(id) {
  // ascundem toate paginile
  document.querySelectorAll('.section-page').forEach(sec => {
    sec.classList.remove('active', 'fullpage');
  });

  // activăm pagina selectată
  const page = document.getElementById(id);
  page.classList.add('active');

  // fullpage pentru token / explorer / xexchange
  if (id === 'token' || id === 'explorerIframe' || id === 'xexchangeIframe') {
    page.classList.add('fullpage');
  }

  // activăm butonul corespunzător
  document.querySelectorAll('.nav-buttons button').forEach(btn => btn.classList.remove('active'));
  document.getElementById('btn-' + id).classList.add('active');

  // zoom special pentru staking
  const viewport = document.querySelector("meta[name=viewport]");
  if (id === "staking") {
    document.body.style.zoom = "0.75";
    viewport.setAttribute(
      "content",
      "width=device-width, initial-scale=0.75, minimum-scale=0.5, maximum-scale=1.0, user-scalable=yes"
    );
  } else {
    document.body.style.zoom = "1";
    viewport.setAttribute(
      "content",
      "width=device-width, initial-scale=0.85, minimum-scale=0.5, maximum-scale=1.0, user-scalable=yes"
    );
  }
}


  // ===== On Load =====
window.onload = function() {


  fetchPoolData();
  fetchGeckoAthAtl();
  updateStakingLeaderboard();
  loadEvents(); // ✅ încarcă și events

  setInterval(function() {
    fetchPoolData();
    fetchGeckoAthAtl();
    const hasValue = parseNumber(document.getElementById('amount').value) > 0;
    if (hasValue) calculate();
  }, 300000);

  setInterval(updateStakingLeaderboard, 15 * 60 * 1000);
};
// Auto-refresh events countdown every minute
setInterval(() => {
  if (currentDay) {
    showEventsForDay(currentDay);
  }
}, 60000); // 60000ms = 1 minut

</script>
</body>
</html>
