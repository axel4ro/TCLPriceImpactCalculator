<!doctype html>
<html lang="en">
<meta charset="utf-8">
<title>TCL dApp – Connect xPortal (WalletConnect v2)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root { --bdr:#e5e7eb; --muted:#6b7280; --txt:#111827; --bg:#ffffff; --mono:#f3f4f6; --brand:#10b981; }
  *{box-sizing:border-box} body{margin:24px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--txt)}
  .wrap{max-width:960px;margin:auto}
  .card{border:1px solid var(--bdr);border-radius:16px;padding:18px;margin:14px 0}
  h1{margin:0 0 10px;font-size:24px}
  h2{margin:0 0 10px;font-size:18px}
  .muted{color:var(--muted);font-size:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--bdr);text-decoration:none;background:#fff;cursor:pointer}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:var(--mono);padding:6px 8px;border-radius:10px;word-break:break-all}
  .kv{display:grid;grid-template-columns:180px 1fr;gap:8px 12px;align-items:start}
  .qr{max-width:320px}
</style>

<div class="wrap">
  <div class="card">
    <h1>TCL dApp – Connect xPortal</h1>
    <p class="muted">Conectează xPortal prin WalletConnect v2, vezi adresa, apoi semnează mesaje. Static-only (GitHub Pages).</p>
  </div>

  <div class="card">
    <h2>Connection</h2>
    <div class="row" style="margin-bottom:10px">
      <button id="btnConnect" class="btn primary">Connect xPortal</button>
      <button id="btnDisconnect" class="btn">Disconnect</button>
    </div>
    <div class="kv">
      <div class="muted">Status</div><div id="status" class="mono">disconnected</div>
      <div class="muted">Address</div><div id="address" class="mono">—</div>
      <div class="muted">Network</div><div id="network" class="mono">mvx:1 (mainnet)</div>
    </div>
    <div id="qrWrap" class="card" style="display:none">
      <h3>Scan with xPortal</h3>
      <img id="qr" alt="QR" class="qr">
      <p class="muted">Deschide xPortal pe telefon și scanează QR-ul.</p>
    </div>
  </div>

  <div class="card">
    <h2>Sign Message</h2>
    <div class="row" style="margin-bottom:10px">
      <input id="msg" class="mono" style="flex:1" value="TCL-VERIFY" />
      <button id="btnSign" class="btn">Sign</button>
      <button id="btnRand" class="btn">Random Nonce</button>
    </div>
    <div class="kv">
      <div class="muted">Signature</div><div id="sig" class="mono">—</div>
    </div>
  </div>
</div>

<!-- CDN: WalletConnect Universal Provider + QR modal -->
<script type="module">
/*
  Minimal dApp static, WalletConnect v2.
  NOTĂ: Pentru MultiversX avem nevoie de „namespace” corect (CAIP-2) și metodele suportate de xPortal.

  Ce folosim:
  - @walletconnect/universal-provider pentru sesiune WC v2
  - @walletconnect/qrcode-modal pentru desktop QR
  - Namespace MultiversX (propus): "mvx"
  - Chain mainnet: "mvx:1"
  - Metode tipice: "mvx_signMessage" (semnare mesaj), "mvx_signTransaction" (semnare tranzacție)

  !!! Ai nevoie de un Project ID: înlocuiește WC_PROJECT_ID mai jos.
*/

import UniversalProvider from "https://unpkg.com/@walletconnect/universal-provider@2.11.3/dist/umd/index.min.js";
import QRCodeModal from "https://unpkg.com/@walletconnect/qrcode-modal@1.8.0/dist/umd/index.min.js";

const WC_PROJECT_ID = "PUT_YOUR_WALLETCONNECT_PROJECT_ID_HERE"; // <-- înlocuiește
const MVX_NAMESPACE = "mvx";
const CHAIN_ID = "1"; // mainnet (devnet: 2, testnet: 0 - valorile pot diferi; ajustează dacă e cazul)
const MVX_CHAIN = `${MVX_NAMESPACE}:${CHAIN_ID}`;

// Elemente UI
const el = (id)=>document.getElementById(id);
const statusEl = el("status");
const addrEl   = el("address");
const netEl    = el("network");
const sigEl    = el("sig");
const msgEl    = el("msg");
const qrWrap   = el("qrWrap");
const qrImg    = el("qr");
const btnConnect    = el("btnConnect");
const btnDisconnect = el("btnDisconnect");
const btnSign       = el("btnSign");
const btnRand       = el("btnRand");

// Stare globală
let provider = null;
let session  = null;
let account  = null;

// Helper: generate random TCL nonce
function randomNonce(){
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  let s = "TCL-";
  for (let i=0;i<6;i++) s += chars[Math.floor(Math.random()*chars.length)];
  return s;
}

async function initProvider(){
  if (provider) return provider;
  provider = await UniversalProvider.init({
    projectId: 3b2862ec02219f2359a7d54b5f0f46ff,
    logger: "error",
    relayUrl: "wss://relay.walletconnect.com",
    metadata: {
      name: "TCL dApp",
      description: "Simple TCL dApp on GitHub Pages",
      url: location.origin,
      icons: ["https://avatars.githubusercontent.com/u/48141889?s=200&v=4"]
    }
  });

  // Evenimente WC v2
  provider.on("display_uri", uri => {
    // desktop → afișăm QR
    if (uri) {
      const qrData = `wc:${uri.split("wc:").pop()}`; // normalize
      QRCodeModal.open(qrData, () => QRCodeModal.close());
      // pentru UX paralel, generăm și un QR <img>, dar modalul de mai sus e suficient
      try {
        // opțional: generare png QR custom cu o lib separată
      } catch {}
      qrWrap.style.display = "";
    }
  });

  provider.on("connect", (data) => {
    QRCodeModal.close();
    qrWrap.style.display = "none";
    session = data.session;
    updateFromSession();
  });

  provider.on("session_update", ({ topic, params }) => {
    const { namespaces } = params;
    if (session) session.namespaces = namespaces;
    updateFromSession();
  });

  provider.on("disconnect", () => {
    QRCodeModal.close();
    qrWrap.style.display = "none";
    session = null;
    account = null;
    renderDisconnected();
  });

  return provider;
}

function updateFromSession(){
  // extragem contul din namespace mvx
  if (!session || !session.namespaces || !session.namespaces[MVX_NAMESPACE]) {
    renderDisconnected();
    return;
  }
  const ns = session.namespaces[MVX_NAMESPACE];
  // accounts de forma "mvx:1:erd1..."
  const acc = (ns.accounts && ns.accounts[0]) || null;
  account = acc ? acc.split(":")[2] : null;
  renderConnected();
}

function renderConnected(){
  statusEl.textContent = "connected";
  addrEl.textContent = account || "—";
  netEl.textContent = MVX_CHAIN + " (mainnet)";
}

function renderDisconnected(){
  statusEl.textContent = "disconnected";
  addrEl.textContent = "—";
  sigEl.textContent = "—";
}

// Connect
btnConnect.onclick = async ()=>{
  try{
    await initProvider();

    // cerem permisiuni pe namespace-ul MultiversX
    await provider.connect({
      optionalNamespaces: {
        [MVX_NAMESPACE]: {
          methods: [
            "mvx_signMessage",
            "mvx_signTransaction"
          ],
          chains: [MVX_CHAIN],
          events: []
        }
      }
    });

    // pe mobil, WalletConnect ar trebui să deschidă xPortal automat
    // pe desktop, se afișează QR (display_uri)
  }catch(e){
    alert("Connect error: " + (e?.message || e));
  }
};

// Disconnect
btnDisconnect.onclick = async ()=>{
  try{
    if (provider) {
      await provider.disconnect();
    }
  }catch(e){
    console.warn(e);
  }
};

// Sign message
btnSign.onclick = async ()=>{
  try{
    if (!provider || !session) {
      alert("Not connected.");
      return;
    }
    const msg = msgEl.value || "TCL-VERIFY";
    // request către xPortal (WalletConnect) — metoda specifică MultiversX
    // Param format (propunere): { address, message } — poate varia în funcție de versiunea xPortal.
    const res = await provider.request({
      topic: session.topic,
      chainId: MVX_CHAIN,
      request: {
        method: "mvx_signMessage",
        params: {
          address: account,
          message: msg
        }
      }
    });

    // xPortal ar trebui să întoarcă { signature: "...", address: "..." } sau similar
    // Ajustează exact în funcție de răspunsul real.
    const signature = res?.signature || res?.result || JSON.stringify(res);
    sigEl.textContent = signature || "n/a";
  }catch(e){
    alert("Sign error: " + (e?.message || e));
  }
};

// Random nonce
btnRand.onclick = ()=>{
  msgEl.value = randomNonce();
};

// Init
renderDisconnected();
</script>
