<!doctype html>
<html lang="ro">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TCL dApp · Conectare xPortal (WalletConnect v2)</title>
<style>
  :root{--bdr:#e5e7eb;--muted:#6b7280;--txt:#111827;--bg:#fff;--mono:#f3f4f6;--brand:#10b981}
  *{box-sizing:border-box}body{margin:24px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--txt);background:var(--bg)}
  .wrap{max-width:880px;margin:auto}
  .card{border:1px solid var(--bdr);border-radius:16px;padding:18px;margin:14px 0}
  h1{margin:0 0 12px;font-size:28px}
  h2{margin:0 0 8px}
  .muted{color:var(--muted);font-size:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--bdr);background:#fff;cursor:pointer}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;background:var(--mono);padding:6px 8px;border-radius:10px;word-break:break-all}
  .grid{display:grid;grid-template-columns:160px 1fr;gap:8px 12px;align-items:start}
  #qr{width:320px;max-width:100%;background:#fff;border-radius:12px;padding:12px;border:1px dashed var(--bdr)}
  .center{display:grid;place-items:center}
  .hidden{display:none !important}
</style>

<div class="wrap">
  <div class="card center">
    <div>
      <h1>Conectează-te cu xPortal</h1>
      <p class="muted">WalletConnect v2 – funcționează pe desktop (QR) și mobil (deeplink). Găzduire statică – perfect pentru GitHub Pages.</p>
    </div>
  </div>

  <div id="connectCard" class="card">
    <h2>1) Scanează sau deschide xPortal</h2>
    <div class="row" style="margin-bottom:10px">
      <button id="btnConnect" class="btn primary">Connect xPortal</button>
      <span class="muted">sau scanează/vezi QR-ul de mai jos ⤵</span>
    </div>
    <div id="qr" class="center">
      <div class="muted">QR / link va apărea aici după ce apeși <b>Connect xPortal</b> sau la fallback.</div>
    </div>
    <p class="muted" style="margin-top:10px">Mobil: apasă „Connect xPortal” pentru a deschide aplicația. Desktop: scanează QR cu xPortal.</p>
  </div>

  <div id="statusCard" class="card hidden">
    <h2>Stare conexiune</h2>
    <div class="grid">
      <div class="muted">Status</div><div id="status" class="mono">disconnected</div>
      <div class="muted">Wallet</div><div id="address" class="mono">—</div>
      <div class="muted">Rețea</div><div id="network" class="mono">mvx:1 (mainnet)</div>
    </div>
    <div class="row" style="margin-top:12px">
      <button id="btnDisconnect" class="btn">Disconnect</button>
      <button id="btnCopyAddr" class="btn">Copy address</button>
    </div>
  </div>

  <div id="signCard" class="card hidden">
    <h2>Sign Message</h2>
    <p class="muted">Mesajul de semnat (nonce) poate veni din URL (?message=...) sau îl poți edita mai jos.</p>
    <div class="row" style="margin-bottom:10px">
      <input id="msg" class="mono" style="flex:1" value="TCL-VERIFY" />
      <button id="btnSignWC" class="btn">Sign (WalletConnect)</button>
      <button id="btnSignDL" class="btn">Sign via xPortal (deeplink)</button>
      <button id="btnCopySig" class="btn">Copy signature (Base64)</button>
    </div>
    <div class="grid">
      <div class="muted">Signature (hex)</div><div id="sigHex" class="mono">—</div>
      <div class="muted">Signature (Base64)</div><div id="sigB64" class="mono">—</div>
    </div>
  </div>
</div>

<script type="module">
import { WalletConnectV2Provider as WalletConnectProvider } from "https://esm.sh/@multiversx/sdk-wallet-connect-provider@6.1.2";
import QRCode from "https://esm.sh/qrcode@1.5.3";
import { Buffer } from "https://esm.sh/buffer@6.0.3";
if (!globalThis.Buffer) globalThis.Buffer = Buffer;

const WC_PROJECT_ID = "3b2862ec02219f2359a7d54b5f0f46ff";
const RELAY_URL = "wss://relay.walletconnect.com";
const CHAIN_ID = "1";
const MVX_CHAIN = `mvx:${CHAIN_ID}`;

const $ = (id) => document.getElementById(id);
const qrDiv = $("qr");
const btnConnect = $("btnConnect");
const btnDisconnect = $("btnDisconnect");
const btnCopyAddr = $("btnCopyAddr");
const statusEl = $("status");
const addrEl = $("address");
const netEl = $("network");
const connectCard = $("connectCard");
const statusCard = $("statusCard");
const signCard = $("signCard");
const btnSignWC = $("btnSignWC");
const btnSignDL = $("btnSignDL");
const btnCopySig = $("btnCopySig");
const msgEl = $("msg");
const sigHexEl = $("sigHex");
const sigB64El = $("sigB64");

let provider = null;
let pendingApproval = null;
let lastUri = null;
let queryMsg = null;

const isMobile = () => /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
const qp = (k) => new URL(location.href).searchParams.get(k) || "";
function qph(k){ const h = new URL(location.href).hash.replace(/^#/, ""); if (!h) return ""; const sp = new URLSearchParams(h); return sp.get(k) || ""; }

function show(el){ el.classList.remove("hidden"); }
function hide(el){ el.classList.add("hidden"); }

function setDisconnected(){
  statusEl.textContent = "disconnected";
  addrEl.textContent = "—";
  sigHexEl.textContent = "—";
  sigB64El.textContent = "—";
  show(connectCard);
  hide(statusCard); hide(signCard);
  qrDiv.innerHTML = `<div class="muted">QR / link va apărea aici după ce apeși <b>Connect xPortal</b> sau la fallback.</div>`;
}

function setConnected(address){
  statusEl.textContent = "connected";
  addrEl.textContent = address || "—";
  hide(connectCard);
  show(statusCard); show(signCard);
}

async function initProvider(){
  if (provider) return provider;
  const callbacks = {
    onClientLogin: async () => {
      const address = await provider.getAddress();
      setConnected(address);
      // dacă vrei auto-sign la ?message=..., decomentează:
      // if (queryMsg) { try { await signViaWalletConnect(); } catch(e){ console.error(e); } }
    },
    onClientLogout: async () => { setDisconnected(); }
  };
  provider = new WalletConnectProvider(callbacks, CHAIN_ID, RELAY_URL, WC_PROJECT_ID, { logger: "error" });
  await provider.init();
  netEl.textContent = `${MVX_CHAIN} (mainnet)`;
  return provider;
}

function buildDeeplinkWC(uri){
  const u = encodeURIComponent(uri);
  return [`xportal://walletconnect?uri=${u}`, `xportal://wc?uri=${u}`];
}

async function renderQR(data){
  const svg = await QRCode.toString(data, { type: "svg", margin: 1 });
  qrDiv.innerHTML = svg;
}

async function startConnect(){
  await initProvider();
  const { uri, approval } = await provider.connect({ methods: ["mvx_signMessage"] });
  lastUri = uri; pendingApproval = approval;

  await renderQR(uri); // pe desktop – QR
  if (isMobile()) {
    const links = buildDeeplinkWC(uri);
    let i = 0; const tryOpen = () => {
      if (i >= links.length) return;
      window.location.href = links[i++];
      setTimeout(tryOpen, 500);
    };
    tryOpen();
  }
  await provider.login({ approval });
}

/* ---------- helpers ---------- */
function hexToB64(hex){
  if (!hex) return "";
  const u8 = Uint8Array.from((hex.replace(/^0x/i,"").match(/.{1,2}/g) || []).map(h => parseInt(h,16)));
  return btoa(String.fromCharCode(...u8));
}
function b64ToHex(b64){
  if (!b64) return "";
  const bin = atob(b64.replace(/-/g,'+').replace(/_/g,'/'));
  let out = "";
  for (let i = 0; i < bin.length; i++) out += bin.charCodeAt(i).toString(16).padStart(2,"0");
  return out;
}
function looksLikeBase64(s){
  return typeof s === "string" && /^[A-Za-z0-9+/_-]+={0,2}$/.test(s) && s.length % 4 === 0;
}
function looksLikeHex(s){
  return typeof s === "string" && /^0x?[0-9a-fA-F]+$/.test(s);
}

/* normalizează diverse forme de răspuns în {hex,b64} */
function normalizeSignature(res){
  // string pur
  if (typeof res === "string"){
    if (looksLikeBase64(res)) return { b64: res, hex: b64ToHex(res) };
    if (looksLikeHex(res))    return { hex: res.replace(/^0x/i,""), b64: hexToB64(res) };
  }
  // array – ia prima piesă utilă
  if (Array.isArray(res)){
    for (const item of res){
      const norm = normalizeSignature(item);
      if (norm.hex || norm.b64) return norm;
    }
  }
  // obiect – multe forme posibile
  if (res && typeof res === "object"){
    // { signature: '...' } sau { data: '...' }
    if (res.signature) return normalizeSignature(res.signature);
    if (res.data)      return normalizeSignature(res.data);
    // { signature: { hex, base64 } }
    if (res.signatureHex || (res.signature && res.signature.hex)){
      const hex = (res.signatureHex || res.signature.hex || "").replace(/^0x/i,"");
      return { hex, b64: hexToB64(hex) };
    }
    if (res.signatureBase64 || (res.signature && (res.signature.base64 || res.signature.b64))){
      const b64 = res.signatureBase64 || res.signature.base64 || res.signature.b64;
      return { b64, hex: b64ToHex(b64) };
    }
  }
  return { hex:"", b64:"" };
}

/* request generic – normalizează params în array pentru ambele API-uri */
async function wcRequest(method, params){
  const arr = Array.isArray(params) ? params : [params];
  if (typeof provider?.sendCustomRequest === "function"){
    return await provider.sendCustomRequest({ method, params: arr });
  }
  if (typeof provider?.request === "function"){
    return await provider.request({ method, params: arr });
  }
  throw new Error("Provider nu expune request() / sendCustomRequest().");
}

/* ---------- sign via WalletConnect (JSON-RPC) ---------- */
async function signViaWalletConnect(){
  await initProvider();
  const message = String(msgEl?.value ?? "");
  if (!message) { alert("Mesaj gol"); return; }
  const address = await provider.getAddress();
  if (!address) { alert("Nu am adresa din provider."); return; }

  const tries = [
    // cele mai comune forme
    [{ address, message }],           // 1) [{address,message}]
    [address, message],               // 2) [address, message]
    [{ message }],                    // 3) [{message}]
    [message],                        // 4) [message]
    [{ message, address }],           // 5) [{message,address}]
  ];

  let res, lastErr = null;
  for (const params of tries){
    try {
      res = await wcRequest("mvx_signMessage", params);
      if (res != null) break;
    } catch(e){ lastErr = e; }
  }
  if (res == null){
    console.error("mvx_signMessage failed. lastErr:", lastErr);
    alert("Nu s-a putut semna prin WalletConnect. Deschidem deeplink xPortal…");
    await signViaDeeplink();
    return;
  }

  const { hex, b64 } = normalizeSignature(res);
  if (!hex && !b64){
    console.warn("Unexpected signMessage result:", res);
    alert("Semnarea a răspuns într-un format neașteptat. Încercăm deeplink.");
    await signViaDeeplink();
    return;
  }

  sigHexEl.textContent = hex || (b64 ? b64ToHex(b64) : "—");
  sigB64El.textContent = b64 || (hex ? hexToB64(hex) : "—");
}

/* ---------- sign via deeplink (fallback sigur) ---------- */
async function signViaDeeplink(){
  const message = String(msgEl?.value ?? "");
  if (!message) { alert("Mesaj gol"); return; }

  const callbackUrl = new URL(location.href);
  callbackUrl.searchParams.set("message", message);

  const params = new URLSearchParams({ message, callbackUrl: callbackUrl.toString() });
  const deeplink = "xportal://wallet/sign-message?" + params.toString();

  if (isMobile()) {
    location.href = deeplink;
  } else {
    await renderQR(deeplink); // scanezi cu xPortal din desktop
  }
}

/* ---------- listeners ---------- */
btnConnect.addEventListener('click', async () => {
  try { await startConnect(); }
  catch (e) { console.error(e); alert("Connect error: " + (e?.message || e)); setDisconnected(); }
});

btnDisconnect.addEventListener('click', async () => {
  try { if (provider) await provider.logout(); } catch {}
  setDisconnected();
});

btnCopyAddr.addEventListener('click', async () => {
  const txt = addrEl.textContent || "";
  try { await navigator.clipboard.writeText(txt); alert('Copied!'); }
  catch { alert('Copy failed'); }
});

btnSignWC.addEventListener('click', async () => {
  try { await signViaWalletConnect(); }
  catch(e){ console.error(e); alert("Sign (WC) error: " + (e?.message || e)); }
});

btnSignDL.addEventListener('click', async () => {
  try { await signViaDeeplink(); }
  catch(e){ console.error(e); alert("Sign (deeplink) error: " + (e?.message || e)); }
});

btnCopySig.addEventListener('click', async () => {
  const txt = sigB64El.textContent || "";
  try { await navigator.clipboard.writeText(txt); alert('Signature (Base64) copied!'); }
  catch { alert('Copy failed'); }
});

/* ---------- init ---------- */
queryMsg =
  qp("message") || qp("nonce") || qp("msg") || qp("m") ||
  qph("message") || qph("nonce") || "";

if (queryMsg) { try { msgEl.value = queryMsg; } catch{} }
setDisconnected();
</script>
</html>
