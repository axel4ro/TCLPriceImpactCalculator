<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TCL dApp · xPortal connect (WalletConnect v2)</title>
<style>
  :root{--bdr:#e5e7eb;--muted:#6b7280;--txt:#111827;--bg:#fff;--mono:#f3f4f6;--brand:#10b981}
  *{box-sizing:border-box}body{margin:24px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--txt);background:var(--bg)}
  .wrap{max-width:920px;margin:auto}
  .card{border:1px solid var(--bdr);border-radius:16px;padding:18px;margin:14px 0}
  h1{margin:0 0 8px;font-size:24px} .muted{color:var(--muted);font-size:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--bdr);background:#fff;cursor:pointer}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;background:var(--mono);padding:6px 8px;border-radius:10px;word-break:break-all}
  .kv{display:grid;grid-template-columns:160px 1fr;gap:8px 12px;align-items:start}
  #qrModal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.6);z-index:50}
  #qrBox{background:#111;padding:16px;border-radius:16px;max-width:360px}
  #qrBox h3{color:#fff;margin:0 0 10px;font-weight:600}
  #qr{width:320px;max-width:100%}
</style>

<div class="wrap">
  <div class="card">
    <h1>TCL dApp – Connect xPortal</h1>
    <p class="muted">Conectare cu xPortal prin WalletConnect v2 (SDK oficial MultiversX). Static (GitHub Pages).</p>
  </div>

  <div class="card">
    <h2>Connection</h2>
    <div class="row" style="margin-bottom:10px">
      <button id="btnConnect" class="btn primary">Connect xPortal</button>
      <button id="btnDisconnect" class="btn">Disconnect</button>
    </div>
    <div class="kv">
      <div class="muted">Status</div><div id="status" class="mono">disconnected</div>
      <div class="muted">Address</div><div id="address" class="mono">—</div>
      <div class="muted">Network</div><div id="network" class="mono">mvx:1 (mainnet)</div>
    </div>
  </div>

  <div class="card">
    <h2>Sign Message</h2>
    <div class="row" style="margin-bottom:10px">
      <input id="msg" class="mono" style="flex:1" value="TCL-VERIFY" />
      <button id="btnRand" class="btn">Random Nonce</button>
      <button id="btnSign" class="btn">Sign</button>
    </div>
    <div class="kv">
      <div class="muted">Signature</div><div id="sig" class="mono">—</div>
    </div>
  </div>
</div>

<!-- Simple QR modal -->
<div id="qrModal">
  <div id="qrBox">
    <h3>Scan with xPortal</h3>
    <div id="qr"></div>
    <div class="muted" style="color:#cbd5e1;margin-top:8px">Deschide xPortal pe telefon și scanează.</div>
  </div>
</div>

<script type="module">
/*
  Conform doc-urilor MultiversX:
  - Folosim @multiversx/sdk-wallet-connect-provider (WalletConnect v2) pentru xPortal.
  - Metode JSON-RPC: mvx_signMessage, mvx_signTransaction(s), etc.  (vezi docs)
  - Namespace mvx, chainId "1" (mainnet) / "T" / "D".
*/

import { WalletConnectV2Provider as WalletConnectProvider } from "https://esm.sh/@multiversx/sdk-wallet-connect-provider@6.1.2";
import { SignableMessage } from "https://esm.sh/@multiversx/sdk-core@13.15.0";
import QRCode from "https://esm.sh/qrcode@1.5.3";

const WC_PROJECT_ID = "3b2862ec02219f2359a7d54b5f0f46ff";   // <-- pune aici Project ID-ul tău
const RELAY_URL     = "wss://relay.walletconnect.com";
const CHAIN_ID      = "1";                 // "1"=mainnet, "T"=testnet, "D"=devnet
const MVX_CHAIN     = `mvx:${CHAIN_ID}`;

const el = id => document.getElementById(id);
const statusEl = el("status"), addrEl = el("address"), netEl = el("network");
const sigEl = el("sig"), msgEl = el("msg");
const btnConnect = el("btnConnect"), btnDisconnect = el("btnDisconnect");
const btnSign = el("btnSign"), btnRand = el("btnRand");
const qrModal = el("qrModal"), qrDiv = el("qr");

let provider = null;

/** UI helpers */
function setConnected(address){
  statusEl.textContent = "connected";
  addrEl.textContent = address || "—";
  netEl.textContent = `${MVX_CHAIN} (mainnet)`;
}
function setDisconnected(){
  statusEl.textContent = "disconnected";
  addrEl.textContent = "—";
  sigEl.textContent = "—";
}
async function openQR(uri){
  // Generează SVG pentru QR și arată modalul
  const svg = await QRCode.toString(uri, { type: "svg", margin: 1 });
  qrDiv.innerHTML = svg;
  qrModal.style.display = "grid";
}
function closeQR(){
  qrModal.style.display = "none";
  qrDiv.innerHTML = "";
}

/** Init provider conform SDK */
async function initProvider(){
  if (provider) return provider;

  const callbacks = {
    onClientLogin: async () => {
      closeQR();
      const address = await provider.getAddress();
      setConnected(address);
    },
    onClientLogout: async () => {
      setDisconnected();
    },
    onClientEvent: async (event) => {
      // optional: console.log("WC event", event);
    }
  };

  provider = new WalletConnectProvider(
    callbacks,
    CHAIN_ID,          // "1" | "T" | "D"
    RELAY_URL,
    WC_PROJECT_ID,
    { logger: "error" } // opțional
  );

  await provider.init();
  return provider;
}

/** Connect flow */
btnConnect.onclick = async () => {
  try {
    await initProvider();

    // Poți cere explicit metode extra; by default sunt mvx_signMessage / signTransaction(s)
    const { uri, approval } = await provider.connect({
      methods: ["mvx_signMessage"]
    });

    // Desktop → arătăm QR; pe mobil, WalletConnect va lansa xPortal (dacă are handler)
    await openQR(uri);

    // Așteaptă aprobarea utilizatorului în xPortal, apoi finalizează login-ul
    await provider.login({ approval });

  } catch (e) {
    closeQR();
    alert("Connect error: " + (e?.message || e));
  }
};

/** Disconnect */
btnDisconnect.onclick = async () => {
  try {
    if (provider) await provider.logout();
  } catch (e) {
    console.warn(e);
  } finally {
    setDisconnected();
  }
};

/** Sign message (mvx_signMessage) */
btnSign.onclick = async () => {
  try {
    if (!provider) { alert("Not connected."); return; }

    const msgStr = msgEl.value || "TCL-VERIFY";
    const message = new SignableMessage({ message: new TextEncoder().encode(msgStr) });
    await provider.signMessage(message);

    // JSON include semnătura în hex; afișăm compact
    const json = message.toJSON(); // { address, message, signature, version }
    sigEl.textContent = json.signature || JSON.stringify(json);

  } catch (e) {
    alert("Sign error: " + (e?.message || e));
  }
};

/** Random nonce helper */
btnRand.onclick = () => {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  let s = "TCL-";
  for (let i=0;i<6;i++) s += chars[Math.floor(Math.random()*chars.length)];
  msgEl.value = s;
};

// Init UI
setDisconnected();
</script>
</html>
